{% extends 'base.html' %}
{% load static %}

{% block title %}Modificar Álbumes{% endblock %}

{% block body %}

<!-- CDN de Bulma 1.0.4 + Bootstrap Icons -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@1.0.4/css/bulma.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

<style>
    :root {
        --primary-orange: #ff6200;
    }
    .title.is-1 {
        color: var(--primary-orange);
    }
    .table thead th {
        background-color: var(--primary-orange);
        color: white;
        text-align: center;
        vertical-align: middle;
    }
    .table td, .table th {
        text-align: center;
        vertical-align: middle;
    }
    .table.is-hoverable tbody tr:hover {
        background-color: #fff5e6;
    }
    .notification.is-success {
        background-color: #e6ffe6;
        color: #006400;
    }
    .notification.is-danger {
        background-color: #ffe6e6;
        color: #8b0000;
    }
    .image.is-64x64 img {
        border-radius: 6px;
        object-fit: cover;
    }
    .button.is-small {
        min-width: 100px;
    }
    .category-tags {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 0.4rem 0.6rem;
        padding: 0.3rem 0;
    }
    .category-tags .tag {
        font-size: 0.85rem;
        padding: 0.4rem 0.8rem;
        margin: 0.2rem;
        border-radius: 6px;
    }
    #searchInput {
        max-width: 400px;
        margin: 0 auto 1.5rem;
    }
    .hidden {
        display: none !important;
    }
</style>

<div class="container py-6">
    <h1 class="title is-1 has-text-centered">
        Modificar Álbumes
    </h1>

    <!-- Buscador -->
    <div class="field has-addons has-addons-centered mb-5">
        <div class="control is-expanded">
            <input class="input is-medium" type="text" id="searchInput" placeholder="Buscar por título del álbum...">
        </div>
        <div class="control">
            <button class="button is-primary is-medium" onclick="document.getElementById('searchInput').value = ''; filterTable();">
                Limpiar
            </button>
        </div>
    </div>

    <!-- Mensajes -->
    <div id="messages-container" class="mb-5"></div>

    {% if list_albunes %}
        <div class="table-container">
            <table class="table is-fullwidth is-striped is-hoverable is-bordered" id="albumTable">
                <thead>
                    <tr>
                        <th class="has-text-centered">ID</th>
                        <th class="has-text-centered" style="width: 25%;">Título</th>
                        <th class="has-text-centered" style="width: 20%;">Artista(s)</th>
                        <th class="has-text-centered" style="width: 12%;">Fecha</th>
                        <th class="has-text-centered" style="width: 15%;">Géneros</th>
                        <th class="has-text-centered" style="width: 8%;">Canciones</th>
                        <th class="has-text-centered" style="width: 15%;">Categorías</th>
                        <th class="has-text-centered" style="width: 10%;">Portada</th>
                        <th class="has-text-centered" style="width: 15%;">Acciones</th>
                    </tr>
                </thead>
                <tbody id="albumes-table">
                    {% for album in list_albunes %}
                        <tr data-album-id="{{ album.code }}" data-title="{{ album.title|lower }}">
                            <td class="has-text-centered">{{ album.code }}</td>
                            <td class="has-text-centered">{{ album.title }}</td>
                            <td class="has-text-centered">{{ album.artist|join:", " }}</td>
                            <td class="has-text-centered">{{ album.release_date|default:"—" }}</td>
                            <td class="has-text-centered">{{ album.genres|join:", " }}</td>
                            <td class="has-text-centered">{{ album.numSongs }}</td>
                            <td class="has-text-centered">
                                <div class="category-tags">
                                    {% for cat_name in album.category_names %}
                                        <span class="tag is-info is-light">{{ cat_name }}</span>
                                    {% empty %}
                                        <span class="tag is-light is-secondary">Sin categorías</span>
                                    {% endfor %}
                                </div>
                            </td>
                            <td class="has-text-centered">
                                {% if album.image %}
                                    <figure class="image is-64x64 mx-auto">
                                        <img src="{{ album.image }}" alt="{{ album.title }}">
                                    </figure>
                                {% else %}
                                    <span class="tag is-light">Sin portada</span>
                                {% endif %}
                            </td>
                            <td class="has-text-centered is-vcentered">
                                <div class="buttons is-centered">
                                    <button class="button is-small is-warning edit-btn mr-2"
                                            data-album-code="{{ album.code }}"
                                            data-album-title="{{ album.title|escapejs }}"
                                            data-album-artist="{{ album.artist|join:", "|escapejs }}"
                                            data-album-release-date="{{ album.release_date|date:'Y-m-d' }}"
                                            data-album-numsongs="{{ album.numSongs }}"
                                            data-album-image="{{ album.image|escapejs }}"
                                            data-album-genres="{{ album.genres|join:", "|escapejs }}">
                                        <span class="icon is-small"><i class="bi bi-pencil-square"></i></span>
                                        <span>Editar</span>
                                    </button>

                                    <button class="button is-small is-danger delete-btn"
                                            data-album-id="{{ album.code }}"
                                            data-album-title="{{ album.title|escapejs }}">
                                        <span class="icon is-small"><i class="bi bi-trash3"></i></span>
                                        <span>Eliminar</span>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    {% else %}
        <div class="notification is-info is-light has-text-centered">
            No hay álbumes registrados en la base de datos.
        </div>
    {% endif %}
</div>

<!-- Modal Edición -->
<div id="editModal" class="modal">
    <div class="modal-background"></div>
    <div class="modal-card">
        <header class="modal-card-head">
            <p class="modal-card-title">Editar Álbum</p>
            <button class="delete" aria-label="close"></button>
        </header>
        <section class="modal-card-body">
            <form id="editForm">
                <input type="hidden" name="album_code" id="album_code">

                <div class="field">
                    <label class="label">Título</label>
                    <div class="control">
                        <input class="input is-fullwidth" type="text" name="title" id="title" required>
                    </div>
                </div>

                <div class="field">
                    <label class="label">Artista(s) (separados por coma)</label>
                    <div class="control">
                        <input class="input is-fullwidth" type="text" name="artist" id="artist" required>
                    </div>
                </div>

                <div class="columns is-multiline">
                    <div class="column is-one-third">
                        <div class="field">
                            <label class="label">Fecha lanzamiento</label>
                            <div class="control">
                                <input class="input is-fullwidth" type="text" name="release_date" id="release_date" placeholder="YYYY-MM-DD">
                            </div>
                        </div>
                    </div>
                    <div class="column is-one-third">
                        <div class="field">
                            <label class="label">Nº canciones</label>
                            <div class="control">
                                <input class="input is-fullwidth" type="text" name="numSongs" id="numSongs" pattern="[0-9]*" inputmode="numeric" placeholder="Ej: 12" required>
                            </div>
                        </div>
                    </div>
                    <div class="column is-one-third">
                        <div class="field">
                            <label class="label">URL portada</label>
                            <div class="control">
                                <input class="input is-fullwidth" type="url" name="image" id="image">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="field">
                    <label class="label">Géneros (separados por coma)</label>
                    <div class="control">
                        <input class="input is-fullwidth" type="text" name="genres" id="genres">
                    </div>
                </div>
            </form>
        </section>
        <footer class="modal-card-foot">
            <button class="button is-success" id="saveChangesBtn">
                <span class="icon"><i class="bi bi-save"></i></span>
                <span>Guardar cambios</span>
            </button>
            <button class="button" id="cancelEdit">Cancelar</button>
        </footer>
    </div>
</div>

<!-- Modal Confirmación Eliminación -->
<div id="deleteConfirmModal" class="modal">
    <div class="modal-background"></div>
    <div class="modal-card">
        <header class="modal-card-head has-background-danger has-text-white">
            <p class="modal-card-title">Confirmar Eliminación</p>
            <button class="delete" aria-label="close"></button>
        </header>
        <section class="modal-card-body">
            <p>¿Estás seguro de que quieres eliminar el álbum <strong id="albumTitleToDelete"></strong> (ID: <span id="albumIdToDelete"></span>)?</p>
            <p class="has-text-danger has-text-weight-bold">Esta acción no se puede deshacer.</p>
        </section>
        <footer class="modal-card-foot">
            <button class="button" id="cancelDelete">Cancelar</button>
            <button class="button is-danger" id="confirmDeleteBtn">Sí, eliminar</button>
        </footer>
    </div>
</div>

<script>
// Funciones modales Bulma
function openModal(id) { document.getElementById(id).classList.add('is-active'); }
function closeModal(id) { document.getElementById(id).classList.remove('is-active'); }

// Buscador en tiempo real
document.getElementById('searchInput').addEventListener('input', filterTable);

function filterTable() {
    const input = document.getElementById('searchInput').value.toLowerCase().trim();
    const rows = document.querySelectorAll('#albumTable tbody tr');

    rows.forEach(row => {
        const title = row.getAttribute('data-title') || '';
        if (title.includes(input)) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
}

// Rellenar modal edición
document.querySelectorAll('.edit-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        document.getElementById('album_code').value     = this.getAttribute('data-album-code');
        document.getElementById('title').value          = this.getAttribute('data-album-title');
        document.getElementById('artist').value         = this.getAttribute('data-album-artist');
        document.getElementById('release_date').value   = this.getAttribute('data-album-release-date') || '';
        document.getElementById('numSongs').value       = this.getAttribute('data-album-numsongs');
        document.getElementById('image').value          = this.getAttribute('data-album-image') || '';
        document.getElementById('genres').value         = this.getAttribute('data-album-genres') || '';
        openModal('editModal');
    });
});

// Guardar cambios AJAX
document.getElementById('saveChangesBtn').addEventListener('click', function() {
    const form = document.getElementById('editForm');
    const formData = new FormData(form);

    const numSongsInput = document.getElementById('numSongs');
    numSongsInput.value = numSongsInput.value.replace(/[^0-9]/g, '');

    fetch("{% url 'rankingApp:editar_album_ajax' %}", {
        method: 'POST',
        body: formData,
        headers: { 'X-CSRFToken': '{{ csrf_token }}' }
    })
    .then(r => r.json())
    .then(data => {
        if (data.status === 'success') {
            showMessage('is-success', data.message);
            location.reload();
        } else {
            showMessage('is-danger', data.message || 'Error al guardar');
        }
    })
    .catch(() => showMessage('is-danger', 'Error de conexión'));
    closeModal('editModal');
});

document.getElementById('cancelEdit').addEventListener('click', () => closeModal('editModal'));

// Eliminación
let albumIdToDelete = null;
document.querySelectorAll('.delete-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        albumIdToDelete = this.getAttribute('data-album-id');
        document.getElementById('albumTitleToDelete').textContent = this.getAttribute('data-album-title');
        document.getElementById('albumIdToDelete').textContent = albumIdToDelete;
        openModal('deleteConfirmModal');
    });
});

document.getElementById('confirmDeleteBtn').addEventListener('click', function() {
    if (!albumIdToDelete) return;
    fetch("{% url 'rankingApp:eliminar_album_ajax' %}", {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({ album_code: albumIdToDelete })
    })
    .then(r => r.json())
    .then(data => {
        if (data.status === 'success') {
            showMessage('is-success', data.message);
            document.querySelector(`tr[data-album-id="${albumIdToDelete}"]`).remove();
        } else {
            showMessage('is-danger', data.message || 'Error al eliminar');
        }
    })
    .catch(() => showMessage('is-danger', 'Error de conexión'));
    closeModal('deleteConfirmModal');
    albumIdToDelete = null;
});

document.getElementById('cancelDelete').addEventListener('click', () => closeModal('deleteConfirmModal'));

// Cerrar modales
document.querySelectorAll('.modal-background, .modal-close, .delete').forEach(el => {
    el.addEventListener('click', () => document.querySelectorAll('.modal.is-active').forEach(m => m.classList.remove('is-active')));
});
document.addEventListener('keydown', e => {
    if (e.key === 'Escape') document.querySelectorAll('.modal.is-active').forEach(m => m.classList.remove('is-active'));
});

// Mensajes
function showMessage(type, text) {
    const container = document.getElementById('messages-container');
    const notif = document.createElement('div');
    notif.className = `notification ${type} is-light`;
    notif.innerHTML = `<button class="delete"></button>${text}`;
    container.appendChild(notif);
    notif.querySelector('.delete').addEventListener('click', () => notif.remove());
}
</script>

{% endblock %}