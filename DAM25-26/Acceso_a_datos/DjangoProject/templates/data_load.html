{% extends 'base.html' %}
{% load static %}

{% block body %}
<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card shadow-sm border-0">
                <div class="card-header bg-white py-3">
                    <h3 class="mb-0 text-center" style="color: var(--primary-orange)">
                        <i class="bi bi-cloud-arrow-up-fill me-2"></i>Cargar Álbumes (CSV)
                    </h3>
                </div>
                <div class="card-body p-4">
                    <form id="csvForm" method="post" enctype="multipart/form-data">
                        {% csrf_token %}
                        <div class="mb-4">
                            <label for="csvFile" class="form-label fw-bold">Selecciona el archivo excel/csv</label>
                            <input class="form-control form-control-lg" type="file" id="csvFile" name="csvFile" accept=".csv" required>
                            <div class="form-text mt-2">Asegúrate de que el formato sea: code, title, artist, date, genres, songs, category, image.</div>
                        </div>

                        <div class="d-flex justify-content-center gap-3">
                            <button type="button" id="previewBtn" class="btn btn-outline-warning px-4">
                                <i class="bi bi-eye me-2"></i>Previsualizar
                            </button>
                            <button type="submit" class="btn btn-primary px-5" style="background-color: var(--primary-orange); border: none;">
                                <i class="bi bi-save me-2"></i>Guardar Datos
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div id="previewContainer" class="mt-5" style="display:none;">
        <div class="card shadow-sm border-0">
            <div class="card-header bg-light d-flex justify-content-between align-items-center">
                <h5 class="mb-0 fw-bold"><i class="bi bi-table me-2"></i>Vista Previa de los Datos</h5>
                <span class="badge bg-secondary">Primeras 5 filas</span>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0" id="previewTable">
                        <thead class="table-dark">
                            </thead>
                        <tbody>
                            </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    document.getElementById('previewBtn').addEventListener('click', function() {
        const fileInput = document.getElementById('csvFile');
        const file = fileInput.files[0];

        if (!file) {
            alert("Por favor, selecciona un archivo CSV primero.");
            return;
        }

        const reader = new FileReader();
        reader.onload = function(e) {
            const content = e.target.result;
            const rows = content.split('\n').filter(row => row.trim() !== "");

            const tableHead = document.querySelector('#previewTable thead');
            const tableBody = document.querySelector('#previewTable tbody');

            // Limpiar tabla previa
            tableHead.innerHTML = "";
            tableBody.innerHTML = "";

            if (rows.length > 0) {
                // 1. Procesar Encabezados (Fila 0)
                const headers = rows[0].split(',');
                const headerRow = document.createElement('tr');
                headers.forEach(h => {
                    const th = document.createElement('th');
                    th.className = "text-center py-3";
                    th.textContent = h.trim().toUpperCase();
                    headerRow.appendChild(th);
                });
                tableHead.appendChild(headerRow);

                // 2. Procesar Filas de Datos (Max 5)
                const dataRows = rows.slice(1, 6);
                dataRows.forEach(row => {
                    const cols = row.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/); // Regex para ignorar comas dentro de comillas
                    const tr = document.createElement('tr');

                    cols.forEach((col, index) => {
                        const td = document.createElement('td');
                        td.className = "text-center";
                        let value = col.replace(/"/g, '').trim();

                        // Lógica especial para la última columna (IMAGEN)
                        if (index === cols.length - 1 && value.startsWith('http')) {
                            td.innerHTML = `
                                <div class="d-flex justify-content-center">
                                    <img src="${value}" alt="Portada"
                                         style="width: 50px; height: 50px; object-fit: cover; border-radius: 6px; border: 1px solid #ddd;">
                                </div>`;
                        } else {
                            // Datos normales
                            td.innerHTML = `<span class="small fw-medium">${value}</span>`;
                        }
                        tr.appendChild(td);
                    });
                    tableBody.appendChild(tr);
                });

                // Mostrar el contenedor
                document.getElementById('previewContainer').style.display = 'block';
                // Hacer scroll suave hacia la tabla
                document.getElementById('previewContainer').scrollIntoView({ behavior: 'smooth' });
            }
        };
        reader.readAsText(file);
    });
</script>

<style>
    /* Estilos adicionales para que combine con tu naranja */
    .btn-outline-warning {
        color: var(--primary-orange);
        border-color: var(--primary-orange);
    }
    .btn-outline-warning:hover {
        background-color: var(--primary-orange);
        border-color: var(--primary-orange);
        color: white;
    }
    .table thead {
        background-color: #343a40;
    }
    #previewTable th {
        font-size: 0.85rem;
        letter-spacing: 1px;
    }
</style>
{% endblock %}